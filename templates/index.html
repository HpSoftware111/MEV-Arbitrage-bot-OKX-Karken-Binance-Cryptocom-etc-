<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEV Bot - XRPUSDT Real-time Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .price-card {
            transition: all 0.3s ease;
        }
        .price-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .price-up {
            color: #10b981;
        }
        .price-down {
            color: #ef4444;
        }
        .opportunity-card {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .status-online {
            color: #10b981;
        }
        .status-offline {
            color: #ef4444;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-chart-line text-3xl text-blue-500"></i>
                    <div>
                        <h1 class="text-2xl font-bold">MEV Bot</h1>
                        <p class="text-gray-400">XRPUSDT Real-time Monitor</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div id="connection-status" class="w-3 h-3 rounded-full bg-red-500"></div>
                        <span id="connection-text" class="text-sm">Disconnected</span>
                    </div>
                    <div class="text-sm text-gray-400">
                        <span id="last-update">Never</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Total Records</p>
                        <p id="total-records" class="text-2xl font-bold">0</p>
                    </div>
                    <i class="fas fa-database text-blue-500 text-2xl"></i>
                </div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Opportunities</p>
                        <p id="total-opportunities" class="text-2xl font-bold">0</p>
                    </div>
                    <i class="fas fa-bullseye text-green-500 text-2xl"></i>
                </div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Profitable</p>
                        <p id="profitable-opportunities" class="text-2xl font-bold">0</p>
                    </div>
                    <i class="fas fa-trophy text-yellow-500 text-2xl"></i>
                </div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Monitoring</p>
                        <p id="monitoring-status" class="text-2xl font-bold">Off</p>
                    </div>
                    <i class="fas fa-play-circle text-purple-500 text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- Current Prices -->
        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-coins mr-2 text-yellow-500"></i>
                Real-time XRPUSDT Prices Across All Exchanges
            </h2>
            <div class="mb-4 text-sm text-gray-400">
                <i class="fas fa-info-circle mr-1"></i>
                Prices update every second via WebSocket connection
            </div>
            <div id="prices-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Price cards will be populated here -->
            </div>
        </div>

        <!-- Arbitrage Opportunities -->
        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-exchange-alt mr-2 text-green-500"></i>
                Arbitrage Opportunities
            </h2>
            <div id="opportunities-container" class="space-y-4">
                <div class="text-center text-gray-400 py-8">
                    <i class="fas fa-search text-4xl mb-4"></i>
                    <p>No opportunities found yet...</p>
                </div>
            </div>
        </div>

        <!-- Exchange Status -->
        <div>
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-server mr-2 text-blue-500"></i>
                Exchange Status
            </h2>
            <div id="exchanges-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Exchange status cards will be populated here -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 mt-12">
        <div class="container mx-auto px-4 py-6">
            <div class="text-center text-gray-400">
                <p>&copy; 2024 MEV Bot - Real-time XRPUSDT Price Monitor</p>
                <p class="text-sm mt-2">Built with FastAPI, WebSocket, and Tailwind CSS</p>
            </div>
        </div>
    </footer>

    <script>
        class MEVBotUI {
            constructor() {
                this.ws = null;
                this.prices = {};
                this.opportunities = [];
                this.stats = {};
                this.init();
            }

            init() {
                this.connectWebSocket();
                this.loadInitialData();
                this.setupEventListeners();
            }

            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    this.updateConnectionStatus(true);
                    console.log('WebSocket connected');
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    } catch (e) {
                        console.log('Non-JSON WebSocket message:', event.data);
                        // Handle non-JSON messages (like pong responses)
                    }
                };
                
                this.ws.onclose = () => {
                    this.updateConnectionStatus(false);
                    console.log('WebSocket disconnected, reconnecting in 3 seconds...');
                    setTimeout(() => this.connectWebSocket(), 3000);
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.updateConnectionStatus(false);
                };
            }

            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'prices':
                        this.updatePrices(data.data);
                        break;
                    case 'opportunities':
                        this.updateOpportunities(data.data);
                        break;
                    default:
                        console.log('Unknown message type:', data.type);
                }
            }

            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connection-status');
                const textEl = document.getElementById('connection-text');
                
                if (connected) {
                    statusEl.className = 'w-3 h-3 rounded-full bg-green-500';
                    textEl.textContent = 'Connected';
                } else {
                    statusEl.className = 'w-3 h-3 rounded-full bg-red-500';
                    textEl.textContent = 'Disconnected';
                }
            }

            async loadInitialData() {
                try {
                    // Load current prices
                    const pricesResponse = await fetch('/prices');
                    if (pricesResponse.ok) {
                        const prices = await pricesResponse.json();
                        this.updatePrices(prices);
                    }

                    // Load opportunities
                    const opportunitiesResponse = await fetch('/arbitrage/opportunities');
                    if (opportunitiesResponse.ok) {
                        const opportunities = await opportunitiesResponse.json();
                        this.updateOpportunities(opportunities);
                    }

                    // Load stats
                    const statsResponse = await fetch('/stats');
                    if (statsResponse.ok) {
                        const stats = await statsResponse.json();
                        this.updateStats(stats);
                    }

                    // Load exchange status
                    const exchangesResponse = await fetch('/exchanges/status');
                    if (exchangesResponse.ok) {
                        const exchanges = await exchangesResponse.json();
                        this.updateExchanges(exchanges);
                    }
                } catch (error) {
                    console.error('Error loading initial data:', error);
                }
            }

            updatePrices(prices) {
                this.prices = {};
                const container = document.getElementById('prices-container');
                container.innerHTML = '';

                // Define all expected exchanges
                const allExchanges = ['kraken', 'okx', 'binance', 'cryptocom'];
                
                allExchanges.forEach(exchangeName => {
                    const price = prices.find(p => p.exchange === exchangeName);
                    
                    const card = document.createElement('div');
                    card.className = 'price-card bg-gray-800 rounded-lg p-6 border border-gray-700';
                    
                    const isOnline = price && price.last_price > 0;
                    const statusClass = isOnline ? 'status-online' : 'status-offline';
                    const statusIcon = isOnline ? 'bg-green-500' : 'bg-red-500';
                    const statusText = isOnline ? 'Online' : 'Offline';
                    
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold capitalize">${exchangeName}</h3>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 rounded-full ${statusIcon}"></div>
                                <span class="text-sm ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Last Price:</span>
                                <span class="font-bold text-lg ${isOnline ? 'text-green-400' : 'text-gray-500'}">
                                    ${isOnline ? '$' + price.last_price.toFixed(4) : 'N/A'}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Bid:</span>
                                <span class="${isOnline ? 'text-white' : 'text-gray-500'}">
                                    ${isOnline ? '$' + price.bid_price.toFixed(4) : 'N/A'}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Ask:</span>
                                <span class="${isOnline ? 'text-white' : 'text-gray-500'}">
                                    ${isOnline ? '$' + price.ask_price.toFixed(4) : 'N/A'}
                                </span>
                            </div>
                            ${isOnline && price.volume ? `
                            <div class="flex justify-between">
                                <span class="text-gray-400">Volume:</span>
                                <span class="text-sm">${price.volume.toLocaleString()}</span>
                            </div>
                            ` : ''}
                            ${isOnline ? `
                            <div class="flex justify-between">
                                <span class="text-gray-400">Updated:</span>
                                <span class="text-xs text-gray-400">${new Date().toLocaleTimeString()}</span>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    
                    container.appendChild(card);
                });

                this.updateLastUpdate();
            }

            updateOpportunities(opportunities) {
                this.opportunities = opportunities;
                const container = document.getElementById('opportunities-container');
                
                if (opportunities.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-search text-4xl mb-4"></i>
                            <p>No opportunities found yet...</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = '';
                opportunities.forEach(opp => {
                    const card = document.createElement('div');
                    card.className = 'opportunity-card bg-gray-800 rounded-lg p-6 border border-gray-700';
                    
                    const profitClass = opp.profit_percentage > 0.5 ? 'text-green-500' : 'text-yellow-500';
                    
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">
                                ${opp.buy_exchange} â†’ ${opp.sell_exchange}
                            </h3>
                            <span class="px-3 py-1 bg-green-900 text-green-300 rounded-full text-sm">
                                ${opp.profit_percentage.toFixed(2)}%
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-gray-400 text-sm">Buy Price</p>
                                <p class="font-bold">$${opp.buy_price.toFixed(4)}</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm">Sell Price</p>
                                <p class="font-bold">$${opp.sell_price.toFixed(4)}</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm">Gross Profit</p>
                                <p class="font-bold text-blue-400">$${opp.gross_profit ? opp.gross_profit.toFixed(4) : 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm">Net Profit</p>
                                <p class="font-bold ${profitClass}">$${opp.profit_amount.toFixed(4)}</p>
                            </div>
                        </div>
                        <div class="bg-gray-700 rounded p-3 mb-4">
                            <h4 class="text-sm font-semibold text-gray-300 mb-2">Cost Breakdown</h4>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div>
                                    <span class="text-gray-400">Buy Fee:</span>
                                    <span class="text-red-400">$${opp.buy_fee ? opp.buy_fee.toFixed(4) : 'N/A'}</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">Sell Fee:</span>
                                    <span class="text-red-400">$${opp.sell_fee ? opp.sell_fee.toFixed(4) : 'N/A'}</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">Buy Slippage:</span>
                                    <span class="text-orange-400">$${opp.buy_slippage ? opp.buy_slippage.toFixed(4) : 'N/A'}</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">Sell Slippage:</span>
                                    <span class="text-orange-400">$${opp.sell_slippage ? opp.sell_slippage.toFixed(4) : 'N/A'}</span>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-600">
                                <div class="flex justify-between text-xs">
                                    <span class="text-gray-400">Total Costs:</span>
                                    <span class="text-red-400">$${opp.total_fees && opp.total_slippage ? (opp.total_fees + opp.total_slippage).toFixed(4) : 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-400">
                            <span>Volume: ${opp.volume.toLocaleString()}</span>
                            <span>${new Date(opp.timestamp).toLocaleString()}</span>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            }

            updateStats(stats) {
                this.stats = stats;
                document.getElementById('total-records').textContent = stats.total_price_records || 0;
                document.getElementById('total-opportunities').textContent = stats.total_arbitrage_opportunities || 0;
                document.getElementById('profitable-opportunities').textContent = stats.profitable_opportunities || 0;
                document.getElementById('monitoring-status').textContent = stats.monitoring_status ? 'On' : 'Off';
            }

            updateExchanges(exchanges) {
                const container = document.getElementById('exchanges-container');
                container.innerHTML = '';

                Object.entries(exchanges).forEach(([name, data]) => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 rounded-lg p-6 border border-gray-700';
                    
                    const isOnline = data.status === 'online';
                    const statusClass = isOnline ? 'status-online' : 'status-offline';
                    
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold capitalize">${name}</h3>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-red-500'}"></div>
                                <span class="text-sm ${statusClass}">${data.status}</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Last Price:</span>
                                <span class="font-bold">$${data.last_price ? data.last_price.toFixed(4) : 'N/A'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Last Update:</span>
                                <span class="text-sm">${data.last_update ? new Date(data.last_update).toLocaleTimeString() : 'Never'}</span>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            }

            updateLastUpdate() {
                const now = new Date();
                document.getElementById('last-update').textContent = now.toLocaleTimeString();
            }

            setupEventListeners() {
                // Auto-refresh every 30 seconds as fallback
                setInterval(() => {
                    if (this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send('ping');
                    }
                }, 30000);
            }
        }

        // Initialize the UI when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MEVBotUI();
        });
    </script>
</body>
</html>
